pipeline {
    agent any

    environment {
        // Tag à tester
        TAG_NAME = "v1.0.0"
    }

    stages {
        stage('Checkout') {
            steps {
                // Récupération du code et des tags
                checkout scm
                script {
                    // Récupérer le tag actuel sans faire échouer le pipeline
                    try {
                        def tagResult = bat(
                            script: '@echo off & git describe --tags --exact-match 2>nul || echo.',
                            returnStdout: true
                        ).trim()
                        env.GIT_TAG = tagResult
                    } catch (Exception e) {
                        // Aucun tag trouvé, on met une chaîne vide
                        env.GIT_TAG = ""
                    }
                    echo "Tag détecté : '${env.GIT_TAG}'"
                }
            }
        }

        stage('Test Tag') {
            steps {
                script {
                    if (env.GIT_TAG == env.TAG_NAME) {
                        echo "Tag ${env.TAG_NAME} trouvé ! Le pipeline continue."
                    } else if (env.GIT_TAG == "") {
                        echo "Pas de tag sur ce commit. Le pipeline s'arrête ici."
                        currentBuild.result = 'SUCCESS'
                        return
                    } else {
                        echo "Tag trouvé (${env.GIT_TAG}) mais ce n'est pas ${env.TAG_NAME}. Le pipeline s'arrête ici."
                        currentBuild.result = 'SUCCESS'
                        return
                    }
                }
            }
        }

        stage('Build') {
            when {
                expression { env.GIT_TAG == env.TAG_NAME }
            }
            steps {
                echo 'Construction du projet...'
                // Commandes Windows pour le build, par exemple :
                // bat 'npm install'
                // bat 'npm run build'
            }
        }

        stage('Deploy') {
            when {
                expression { env.GIT_TAG == env.TAG_NAME }
            }
            steps {
                echo 'Déploiement du projet...'
                // Commandes Windows pour le déploiement, par exemple :
                // bat 'copy dist\\* C:\\serveur\\projet\\'
            }
        }
    }

    post {
        always {
            echo "Fin du pipeline."
        }
    }
}
